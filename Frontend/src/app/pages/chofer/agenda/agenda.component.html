<div class="container-fluid p-4">
  <div class="agenda-final">
    <div class="header-final">
      <h1 class="titulo-final">
        <i class="bi bi-calendar-week icono-final"></i>
        Agenda Semanal de Traslados
      </h1>
      <p class="subtitulo-final">Semana del 26 de Mayo al 01 de Junio, 2025</p>
    </div>

    <!-- Loading -->
    @if (loading()) {
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2">Cargando agenda...</p>
      </div>
    }

    <!-- Error -->
    @if (error()) {
      <div class="alert alert-danger mx-4" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ error() }}
      </div>
    }

    @if (agendaData() && !loading()) {
      
      <!-- Vista DESKTOP: Grid -->
      <div class="d-none d-md-block">
        <div class="contenido-final">
          <div class="table-responsive">
            <table class="table table-borderless">
              <thead>
                <tr>
                  <th style="width: 110px;"></th>
                  @for (dia of diasSemana; track dia) {
                    <th class="dia-final">{{ dia }}</th>
                  }
                </tr>
              </thead>
              <tbody>
                @for (horaData of organizarTrasladosPorGrid() | keyvalue; track horaData.key) {
                  <tr>
                    <td class="hora-final">{{ horaData.key }}</td>
                    @for (traslado of horaData.value; track $index) {
                      <td>
                        @if (traslado) {
                          <div class="traslado-final" (click)="abrirDetalle(traslado)">
                            <div class="paciente-final">{{ traslado.nombreCompletoPaciente }}</div>
                            @if (traslado.sillaRueda) {
                              <div class="silla-final">
                                <i class="bi bi-person-wheelchair"></i>
                              </div>
                            }
                          </div>
                        } @else {
                          <div class="vacio-final">—</div>
                        }
                      </td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Vista MOBILE: Lista por día -->
      <div class="d-md-none">
        <div class="contenido-final">
          @for (dia of diasSemana; track $index; let i = $index) {
            <div class="card mb-3">
              <div class="card-header text-white" style="background-color: #3182ce;">
                <h6 class="mb-0">{{ dia }}</h6>
              </div>
              <div class="card-body p-2">
                @for (horaData of organizarTrasladosPorGrid() | keyvalue; track horaData.key) {
                  @if (horaData.value[i]) {
                    <div class="border rounded p-3 mb-2 cursor-pointer" (click)="abrirDetalle(horaData.value[i])">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <small class="text-muted">{{ horaData.key }}</small>
                          <div class="fw-semibold">{{ horaData.value[i].nombreCompletoPaciente }}</div>
                        </div>
                        @if (horaData.value[i].sillaRueda) {
                          <i class="bi bi-person-wheelchair text-success fs-4"></i>
                        }
                      </div>
                    </div>
                  }
                }
                @if (getTrasladosParaDia(i).length === 0) {
                  <p class="text-muted mb-0 text-center py-3"><small>Sin traslados programados</small></p>
                }
              </div>
            </div>
          }
        </div>
      </div>

    }
  </div>
</div>

<!-- Modal de Detalle -->
@if (mostrarModal()) {
  <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-info-circle me-2"></i>
            Detalle del Traslado
          </h5>
          <button type="button" class="btn-close" (click)="cerrarModal()"></button>
        </div>
        
        @if (trasladoSeleccionado()) {
          <div class="modal-body">
            <div class="mb-3">
              <h6 class="text-primary">
                <i class="bi bi-person me-2"></i>Paciente
              </h6>
              <p class="mb-1"><strong>{{ trasladoSeleccionado()?.nombreCompletoPaciente }}</strong></p>
              @if (trasladoSeleccionado()?.telefonoPaciente) {
                <p class="mb-0">
                  <i class="bi bi-telephone me-1"></i>
                  {{ trasladoSeleccionado()?.telefonoPaciente }}
                </p>
              }
            </div>

            <div class="mb-3">
              <h6 class="text-primary">
                <i class="bi bi-clock me-2"></i>Horario
              </h6>
              <p class="mb-1">{{ formatearHora(trasladoSeleccionado()?.horaProgramada) }}</p>
              @if (trasladoSeleccionado()?.sillaRueda) {
                <span class="badge bg-success">
                  <i class="bi bi-person-wheelchair me-1"></i>Silla de ruedas
                </span>
              }
            </div>

            <div class="mb-3">
              <h6 class="text-primary">
                <i class="bi bi-geo-alt me-2"></i>Ruta
              </h6>
              <p class="mb-1">
                <strong>Origen:</strong> {{ trasladoSeleccionado()?.direccionOrigen }}
              </p>
              <p class="mb-0">
                <strong>Destino:</strong> {{ trasladoSeleccionado()?.direccionDestino }}
              </p>
            </div>

            @if (trasladoSeleccionado()?.observaciones) {
              <div class="mb-3">
                <h6 class="text-primary">
                  <i class="bi bi-chat-text me-2"></i>Observaciones
                </h6>
                <p class="mb-0">{{ trasladoSeleccionado()?.observaciones }}</p>
              </div>
            }
          </div>
        }
        
        <div class="modal-footer">
          @if (trasladoSeleccionado()?.telefonoPaciente) {
            <button type="button" class="btn btn-success" 
                    (click)="llamarPaciente(trasladoSeleccionado()?.telefonoPaciente)">
              <i class="bi bi-telephone me-1"></i>Llamar
            </button>
          }
          <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
}